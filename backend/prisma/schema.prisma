// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model User {
  id                String   @id @default(uuid())
  name              String
  phoneNumber       String   @unique @map("phone_number")
  locationState     String   @map("location_state")
  locationDistrict  String   @map("location_district")
  locationPincode   String   @map("location_pincode")
  locationLat       Float?   @map("location_lat")
  locationLng       Float?   @map("location_lng")
  preferredLanguage String   @map("preferred_language")
  userType          String   @map("user_type")
  reputationScore   Float    @default(0.0) @map("reputation_score")
  isVerified        Boolean  @default(false) @map("is_verified")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
  lastActive        DateTime @default(now()) @map("last_active")

  // Relations
  listings          ProductListing[]
  sentMessages      Message[]        @relation("SentMessages")
  receivedMessages  Message[]        @relation("ReceivedMessages")
  buyerChats        Chat[]           @relation("BuyerChats")
  sellerChats       Chat[]           @relation("SellerChats")
  buyerDeals        Deal[]           @relation("BuyerDeals")
  sellerDeals       Deal[]           @relation("SellerDeals")
  givenRatings      Rating[]         @relation("GivenRatings")
  receivedRatings   Rating[]         @relation("ReceivedRatings")

  @@map("users")
}

model Category {
  id       String  @id @default(uuid())
  name     String
  parentId String? @map("parent_id")
  
  // Relations
  parent      Category?        @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    Category[]       @relation("CategoryHierarchy")
  listings    ProductListing[]

  @@map("categories")
}

model ProductListing {
  id              String   @id @default(uuid())
  sellerId        String   @map("seller_id")
  productName     String   @map("product_name")
  categoryId      String   @map("category_id")
  description     String?
  quantityAmount  Float    @map("quantity_amount")
  quantityUnit    String   @map("quantity_unit")
  priceAmount     Float    @map("price_amount")
  priceCurrency   String   @default("INR") @map("price_currency")
  priceUnit       String   @map("price_unit")
  locationState   String   @map("location_state")
  locationDistrict String  @map("location_district")
  locationPincode String   @map("location_pincode")
  locationLat     Float?   @map("location_lat")
  locationLng     Float?   @map("location_lng")
  images          String?  // Comma-separated image URLs
  language        String
  status          String   @default("active")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  expiresAt       DateTime @map("expires_at")

  // Relations
  seller   User     @relation(fields: [sellerId], references: [id], onDelete: Cascade)
  category Category @relation(fields: [categoryId], references: [id])
  chats    Chat[]

  @@map("product_listings")
}

model Chat {
  id            String   @id @default(uuid())
  buyerId       String   @map("buyer_id")
  sellerId      String   @map("seller_id")
  listingId     String   @map("listing_id")
  status        String   @default("active")
  createdAt     DateTime @default(now()) @map("created_at")
  lastMessageAt DateTime @default(now()) @map("last_message_at")

  // Relations
  buyer    User           @relation("BuyerChats", fields: [buyerId], references: [id], onDelete: Cascade)
  seller   User           @relation("SellerChats", fields: [sellerId], references: [id], onDelete: Cascade)
  listing  ProductListing @relation(fields: [listingId], references: [id], onDelete: Cascade)
  messages Message[]
  deals    Deal[]

  @@map("chats")
}

model Message {
  id               String   @id @default(uuid())
  chatId           String   @map("chat_id")
  senderId         String   @map("sender_id")
  receiverId       String   @map("receiver_id")
  originalText     String   @map("original_text")
  originalLanguage String   @map("original_language")
  createdAt        DateTime @default(now()) @map("created_at")

  // Relations
  chat     Chat @relation(fields: [chatId], references: [id], onDelete: Cascade)
  sender   User @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)
  receiver User @relation("ReceivedMessages", fields: [receiverId], references: [id], onDelete: Cascade)

  @@map("messages")
}

model Deal {
  id           String    @id @default(uuid())
  chatId       String    @map("chat_id")
  buyerId      String    @map("buyer_id")
  sellerId     String    @map("seller_id")
  agreedPrice  Float     @map("agreed_price")
  quantity     Float
  status       String    @default("pending")
  createdAt    DateTime  @default(now()) @map("created_at")
  completedAt  DateTime? @map("completed_at")

  // Relations
  chat   Chat @relation(fields: [chatId], references: [id], onDelete: Cascade)
  buyer  User @relation("BuyerDeals", fields: [buyerId], references: [id], onDelete: Cascade)
  seller User @relation("SellerDeals", fields: [sellerId], references: [id], onDelete: Cascade)
  ratings Rating[]

  @@map("deals")
}

model Rating {
  id        String   @id @default(uuid())
  dealId    String   @map("deal_id")
  raterId   String   @map("rater_id")
  ratedId   String   @map("rated_id")
  rating    Int
  comment   String?
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  deal  Deal @relation(fields: [dealId], references: [id], onDelete: Cascade)
  rater User @relation("GivenRatings", fields: [raterId], references: [id], onDelete: Cascade)
  rated User @relation("ReceivedRatings", fields: [ratedId], references: [id], onDelete: Cascade)

  @@unique([dealId, raterId])
  @@map("ratings")
}

model PriceData {
  id              String   @id @default(uuid())
  productName     String   @map("product_name")
  category        String?
  price           Float
  unit            String
  source          String
  sourceName      String   @map("source_name")
  locationState   String?  @map("location_state")
  locationDistrict String? @map("location_district")
  locationPincode String?  @map("location_pincode")
  confidenceScore Float?   @map("confidence_score")
  collectedAt     DateTime @default(now()) @map("collected_at")
  createdAt       DateTime @default(now()) @map("created_at")

  @@map("price_data")
}

model OTPVerification {
  id          String   @id @default(uuid())
  phoneNumber String   @map("phone_number")
  otp         String
  expiresAt   DateTime @map("expires_at")
  verified    Boolean  @default(false)
  createdAt   DateTime @default(now()) @map("created_at")

  @@map("otp_verifications")
}

model Session {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  @@map("sessions")
}